import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,e as t}from"./app-bd8f263d.js";const p={},o=t(`<div class="hint-container tip"><p class="hint-container-title">✨✨✨✨✨</p><p>工作中经常会遇到级联数据的管理，例如行政区划，在拉取级联树的时候不方便，在这里记录一种操作级联数据的方法，生成一个代码链，用与管理级联数据之间的关系</p></div><h2 id="说明" tabindex="-1"><a class="header-anchor" href="#说明" aria-hidden="true">#</a> 说明</h2><p>以行政区划为例，为每一级行政机构分配一个四位数的代码，例如：浙江省-0001，杭州市-00010001，宁波市-00010002，西湖区-000100010001，以此类推，暂且将这种代码的组合称为 代码链。</p><ol><li>初始化，若在设计表的时候没有引入 <code>代码链</code>字段，后期增加该字段的时候需要对数据进行批量赋值</li><li>修改时，若修改父子层级关系，需要将被修改的行政区划及其所有子级的行政区划的代码链进行修改</li><li>新增时，为新增的行政区划分配一个新的代码链，通常为同级代码链+1</li></ol><h2 id="_1-初始化" tabindex="-1"><a class="header-anchor" href="#_1-初始化" aria-hidden="true">#</a> 1. 初始化</h2><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>summary</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// 行政区划代码链初始化</span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>summary</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>biaoZhunDM<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>returns</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>returns</span><span class="token punctuation">&gt;</span></span></span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">XingZhengQHDMLInit</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> biaoZhunDM<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//将所有数据放入缓存，方便递归</span>
    <span class="token class-name"><span class="token keyword">var</span></span> allList <span class="token operator">=</span> <span class="token keyword">await</span> _xingZhengQHBMRepository
    <span class="token punctuation">.</span><span class="token function">AsNoTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GY_ZD_XingZhengQHBMModel</span>
    <span class="token punctuation">{</span>
        Id <span class="token operator">=</span> x<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
        BiaoZhunDM <span class="token operator">=</span> x<span class="token punctuation">.</span>BiaoZhunDM<span class="token punctuation">,</span>
        FuJiDM <span class="token operator">=</span> x<span class="token punctuation">.</span>FuJiDM<span class="token punctuation">,</span>
        DaiMaLian <span class="token operator">=</span> x<span class="token punctuation">.</span>DaiMaLian
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//查询当前标准代码对应的数据</span>
    <span class="token class-name"><span class="token keyword">var</span></span> entity <span class="token operator">=</span> allList<span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>BiaoZhunDM <span class="token operator">==</span> biaoZhunDM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//递归更新子集代码链</span>
    <span class="token comment">//批量更新错误信息</span>
    <span class="token class-name"><span class="token keyword">var</span></span> errMsgList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">UpdateDaiMaLianByRecursion</span><span class="token punctuation">(</span>allList<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>GY_ZD_XingZhengQHBMModel<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> entity <span class="token punctuation">}</span><span class="token punctuation">,</span> errMsgList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token char">&#39;|&#39;</span><span class="token punctuation">,</span> errMsgList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>summary</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// 递归更新代码链</span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>summary</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>allList<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>所有行政区划列表<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fuJiEntityList<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>父级行政区划列表<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>returns</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>returns</span><span class="token punctuation">&gt;</span></span></span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">UpdateDaiMaLianByRecursion</span><span class="token punctuation">(</span><span class="token class-name">List<span class="token punctuation">&lt;</span>GY_ZD_XingZhengQHBMModel<span class="token punctuation">&gt;</span></span> allList<span class="token punctuation">,</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>GY_ZD_XingZhengQHBMModel<span class="token punctuation">&gt;</span></span> fuJiEntityList<span class="token punctuation">,</span> <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> errMsgList<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//根据传入的父级行政区划查找所有子级行政区划</span>
    <span class="token class-name"><span class="token keyword">var</span></span> childList <span class="token operator">=</span> allList
        <span class="token punctuation">.</span><span class="token function">GroupJoin</span><span class="token punctuation">(</span>fuJiEntityList<span class="token punctuation">,</span> all <span class="token operator">=&gt;</span> all<span class="token punctuation">.</span>FuJiDM<span class="token punctuation">,</span> fuJi <span class="token operator">=&gt;</span> fuJi<span class="token punctuation">.</span>BiaoZhunDM<span class="token punctuation">,</span> <span class="token punctuation">(</span>all<span class="token punctuation">,</span> fuJi<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> all<span class="token punctuation">,</span> fuJi <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">SelectMany</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>fuJi<span class="token punctuation">.</span><span class="token function">DefaultIfEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>all<span class="token punctuation">,</span> fuJi<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> all<span class="token punctuation">.</span>all<span class="token punctuation">,</span> fuJi <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>fuJi <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>all<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>childList<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token comment">//按照父级代码分组</span>
    <span class="token class-name"><span class="token keyword">var</span></span> groupList <span class="token operator">=</span> childList<span class="token punctuation">.</span><span class="token function">GroupBy</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>FuJiDM<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x<span class="token operator">=&gt;</span>x<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//批量更新子集代码链</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> item <span class="token keyword">in</span> groupList<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> fuJiEntity <span class="token operator">=</span> fuJiEntityList<span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>BiaoZhunDM <span class="token operator">==</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> list <span class="token operator">=</span> childList<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>FuJiDM <span class="token operator">==</span> item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> child <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            child<span class="token punctuation">.</span>DaiMaLian <span class="token operator">=</span> fuJiEntity<span class="token punctuation">.</span>DaiMaLian <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PadLeft</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token char">&#39;0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _xingZhengQHBMRepository<span class="token punctuation">.</span><span class="token function">BatchUpdateAsync</span><span class="token punctuation">(</span>childList<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> x<span class="token punctuation">.</span>DaiMaLian <span class="token punctuation">}</span><span class="token punctuation">,</span> y <span class="token operator">=&gt;</span> y<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        errMsgList<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;部分批量更新失败，失败层级父级ID：[&quot;</span> <span class="token operator">+</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token char">&#39;,&#39;</span><span class="token punctuation">,</span> fuJiEntityList<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;,失败原因：&quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//从数据集中排除已更新的</span>
    allList <span class="token operator">=</span> allList
        <span class="token punctuation">.</span><span class="token function">GroupJoin</span><span class="token punctuation">(</span>childList<span class="token punctuation">,</span> all <span class="token operator">=&gt;</span> all<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> child <span class="token operator">=&gt;</span> child<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> <span class="token punctuation">(</span>all<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> all<span class="token punctuation">,</span> child <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">SelectMany</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token function">DefaultIfEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>all<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> all<span class="token punctuation">.</span>all<span class="token punctuation">,</span> child <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>child <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>all<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">UpdateDaiMaLianByRecursion</span><span class="token punctuation">(</span>allList<span class="token punctuation">,</span> childList<span class="token punctuation">,</span> errMsgList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-新增" tabindex="-1"><a class="header-anchor" href="#_2-新增" aria-hidden="true">#</a> 2. 新增</h2><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>summary</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// 新增行政区划</span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>summary</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>createDto<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>returns</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>returns</span><span class="token punctuation">&gt;</span></span></span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">AddXingZengQH</span><span class="token punctuation">(</span><span class="token class-name">GY_ZD_XingZhengQHBMCreateDto</span> createDto<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> count <span class="token operator">=</span> <span class="token keyword">await</span> _xingZhengQHBMRepository<span class="token punctuation">.</span><span class="token function">CountAsync</span><span class="token punctuation">(</span>entity <span class="token operator">=&gt;</span> entity<span class="token punctuation">.</span>DaiMaLB <span class="token operator">==</span> createDto<span class="token punctuation">.</span>DaiMaLB <span class="token operator">&amp;&amp;</span> entity<span class="token punctuation">.</span>BiaoZhunDM <span class="token operator">==</span> createDto<span class="token punctuation">.</span>BiaoZhunDM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TongYongYWException</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;行政区划已存在！&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name"><span class="token keyword">var</span></span> entity <span class="token operator">=</span> createDto<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">MapTo</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GY_ZD_XingZhengQHBMCreateDto<span class="token punctuation">,</span> GY_ZD_XingZhengQHBMModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token preprocessor property">#<span class="token directive keyword">region</span> 代码链赋值</span>
    <span class="token comment">//两种情况</span>
    <span class="token comment">//1.新增的行政区划是父级下面的第一个子级，这时代码链需要在父级基础上增加四位</span>
    <span class="token comment">//2.新增的行政区划不是父级下面的第一个子级，这时代码链需要取子级最大的代码链</span>
    <span class="token comment">//当出现第一种情况时，获取的代码链是父级代码链后追加四个0，这是为了下面生成最新的代码链，并且不会影响取最大值</span>
    <span class="token class-name"><span class="token keyword">var</span></span> daiMaLian <span class="token operator">=</span> <span class="token keyword">await</span> _xingZhengQHBMRepository
            <span class="token punctuation">.</span><span class="token function">AsNoTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>FuJiDM <span class="token operator">==</span> createDto<span class="token punctuation">.</span>FuJiDM <span class="token operator">||</span> x<span class="token punctuation">.</span>BiaoZhunDM <span class="token operator">==</span> createDto<span class="token punctuation">.</span>FuJiDM<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> <span class="token keyword">new</span>
            <span class="token punctuation">{</span>
                DaiMaLian <span class="token operator">=</span> x<span class="token punctuation">.</span>FuJiDM <span class="token operator">==</span> createDto<span class="token punctuation">.</span>FuJiDM <span class="token punctuation">?</span> x<span class="token punctuation">.</span>DaiMaLian <span class="token punctuation">:</span>  x<span class="token punctuation">.</span>DaiMaLian <span class="token operator">+</span> <span class="token string">&quot;0000&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x<span class="token operator">=&gt;</span>x<span class="token punctuation">.</span>DaiMaLian<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">MaxAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    entity<span class="token punctuation">.</span>DaiMaLian <span class="token operator">=</span> daiMaLian<span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> daiMaLian<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>Convert<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>daiMaLian<span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span>daiMaLian<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PadLeft</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token char">&#39;0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
    entity<span class="token punctuation">.</span>DaiMaID <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">entity<span class="token punctuation">.</span>DaiMaLB</span><span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">entity<span class="token punctuation">.</span>BiaoZhunDM</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _xingZhengQHBMRepository<span class="token punctuation">.</span><span class="token function">InsertAsync</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> _unitOfWork<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-修改" tabindex="-1"><a class="header-anchor" href="#_3-修改" aria-hidden="true">#</a> 3. 修改</h2><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>summary</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// 修改行政区划</span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>summary</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>updateDto<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param</span><span class="token punctuation">&gt;</span></span></span>
<span class="token doc-comment comment">/// <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>returns</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>returns</span><span class="token punctuation">&gt;</span></span></span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">UpdateXingZengQH</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> id<span class="token punctuation">,</span> <span class="token class-name">GY_ZD_XingZhengQHBMUpdateDto</span> updateDto<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> _unitOfWork<span class="token punctuation">.</span><span class="token function">BeginTransactionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> entity <span class="token operator">=</span> <span class="token keyword">await</span> _xingZhengQHBMRepository<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WeiZhaoDSException</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;行政区划不存在！&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name"><span class="token keyword">var</span></span> count <span class="token operator">=</span> <span class="token keyword">await</span> _xingZhengQHBMRepository<span class="token punctuation">.</span><span class="token function">CountAsync</span><span class="token punctuation">(</span>entity <span class="token operator">=&gt;</span> entity<span class="token punctuation">.</span>Id <span class="token operator">!=</span> id <span class="token operator">&amp;&amp;</span> entity<span class="token punctuation">.</span>DaiMaLB <span class="token operator">==</span> updateDto<span class="token punctuation">.</span>DaiMaLB <span class="token operator">&amp;&amp;</span> entity<span class="token punctuation">.</span>BiaoZhunDM <span class="token operator">==</span> updateDto<span class="token punctuation">.</span>BiaoZhunDM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TongYongYWException</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;行政区划已存在！&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token preprocessor property">#<span class="token directive keyword">region</span> 代码链更新</span>
        <span class="token comment">//层级是否修改</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span>FuJiDM <span class="token operator">!=</span> updateDto<span class="token punctuation">.</span>FuJiDM<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//查询原代码链</span>
            <span class="token class-name"><span class="token keyword">var</span></span> oldDaiMaLian <span class="token operator">=</span> <span class="token keyword">await</span> _xingZhengQHBMRepository<span class="token punctuation">.</span><span class="token function">AsNoTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>DaiMaLian<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//查询新层级下的最大代码链 此处逻辑参考新增</span>
            <span class="token class-name"><span class="token keyword">var</span></span> newDaiMaLian <span class="token operator">=</span> <span class="token keyword">await</span> _xingZhengQHBMRepository
            <span class="token punctuation">.</span><span class="token function">AsNoTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>FuJiDM <span class="token operator">==</span> updateDto<span class="token punctuation">.</span>FuJiDM <span class="token operator">||</span> x<span class="token punctuation">.</span>BiaoZhunDM <span class="token operator">==</span> updateDto<span class="token punctuation">.</span>FuJiDM<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> <span class="token keyword">new</span>
            <span class="token punctuation">{</span>
                DaiMaLian <span class="token operator">=</span> x<span class="token punctuation">.</span>FuJiDM <span class="token operator">==</span> updateDto<span class="token punctuation">.</span>FuJiDM <span class="token punctuation">?</span> x<span class="token punctuation">.</span>DaiMaLian <span class="token punctuation">:</span> x<span class="token punctuation">.</span>DaiMaLian <span class="token operator">+</span> <span class="token string">&quot;0000&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>DaiMaLian<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">MaxAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//更新代码链</span>
            entity<span class="token punctuation">.</span>DaiMaLian <span class="token operator">=</span> newDaiMaLian<span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> newDaiMaLian<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>Convert<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>newDaiMaLian<span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span>newDaiMaLian<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PadLeft</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token char">&#39;0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//查询所有需要更新代码链的子级</span>
            <span class="token class-name"><span class="token keyword">var</span></span> childList <span class="token operator">=</span> <span class="token keyword">await</span> _xingZhengQHBMRepository 
                <span class="token punctuation">.</span><span class="token function">AsNoTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>DaiMaLian<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span>oldDaiMaLian<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>DaiMaLian <span class="token operator">!=</span> oldDaiMaLian<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GY_ZD_XingZhengQHBMModel</span>
                <span class="token punctuation">{</span>
                    Id <span class="token operator">=</span> x<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
                    DaiMaLian <span class="token operator">=</span> entity<span class="token punctuation">.</span>DaiMaLian <span class="token operator">+</span> x<span class="token punctuation">.</span>DaiMaLian<span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span>oldDaiMaLian<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> x<span class="token punctuation">.</span>DaiMaLian<span class="token punctuation">.</span>Length <span class="token operator">-</span> oldDaiMaLian<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token comment">//更新后的代码链</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//批量更新子集代码链</span>
            <span class="token keyword">await</span> _xingZhengQHBMRepository<span class="token punctuation">.</span><span class="token function">BatchUpdateAsync</span><span class="token punctuation">(</span>childList<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> x<span class="token punctuation">.</span>DaiMaLian <span class="token punctuation">}</span><span class="token punctuation">,</span> y <span class="token operator">=&gt;</span> y<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token preprocessor property">#</span><span class="token return-type class-name">endregion</span>
        entity<span class="token punctuation">.</span><span class="token function">Merge</span><span class="token punctuation">(</span>updateDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        entity<span class="token punctuation">.</span>DaiMaID <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">entity<span class="token punctuation">.</span>DaiMaLB</span><span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">entity<span class="token punctuation">.</span>BiaoZhunDM</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> _xingZhengQHBMRepository<span class="token punctuation">.</span><span class="token function">UpdateAsync</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> _unitOfWork<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> _unitOfWork<span class="token punctuation">.</span><span class="token function">CommitTransactionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _unitOfWork<span class="token punctuation">.</span><span class="token function">RollbackTransactionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TongYongYWException</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,10),c=[o];function e(l,i){return s(),a("div",null,c)}const r=n(p,[["render",e],["__file","cascade-data-management.html.vue"]]);export{r as default};
